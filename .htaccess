<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  # Serve existing files/directories
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]
  # SPA fallback to index.html
  RewriteRule . index.html [L]

  # Handle CORS preflight requests universally (204 No Content)
  RewriteCond %{REQUEST_METHOD} OPTIONS
  RewriteRule ^ - [R=204,L]
</IfModule>

# CORS headers (adjust origin if you restrict)
<IfModule mod_headers.c>
  Header always set Access-Control-Allow-Origin "*"
  Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
  Header always set Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "no-referrer-when-downgrade"
  Header always set X-Frame-Options "SAMEORIGIN"
</IfModule>

# Ensure Authorization is available to upstream handlers (PHP/FPM)
SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1

# Compression
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain text/html text/css application/javascript application/json image/svg+xml
</IfModule>

# Static asset caching
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType text/css "access plus 7 days"
  ExpiresByType application/javascript "access plus 7 days"
  ExpiresByType image/svg+xml "access plus 30 days"
  ExpiresByType image/png "access plus 30 days"
  ExpiresByType image/jpeg "access plus 30 days"
  ExpiresByType image/webp "access plus 30 days"
</IfModule>

# Disable directory listing
Options -Indexes
